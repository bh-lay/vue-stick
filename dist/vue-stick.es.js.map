{"version":3,"file":"vue-stick.es.js","sources":["../src/vue-stick.js","../src/utils.js"],"sourcesContent":["import template from './template.html'\nimport './style.less'\nimport { getImgSize, getScrollTop } from './utils.js'\n\nvar component = {\n\tprops: {\n\t\tlist: {\n\t\t\ttype: Array,\n\t\t\tdefault: []\n\t\t},\n\t\tcolumnWidth: {\n\t\t\ttype: Number,\n\t\t\tdefault: 280\n\t\t},\n\t\tanimationClass: {\n\t\t\ttype: String,\n\t\t\tdefault: 'stick-fade-in'\n\t\t},\n\t\tloadTriggerDistance: {\n\t\t\ttype: Number,\n\t\t\tdefault: 1000\n\t\t},\n\t\tcolumnSpacing: {\n\t\t\ttype: Number,\n\t\t\tdefault: 10\n\t\t}\n\t},\n\tdata: function () {\n\t\treturn {\n\t\t\tcount: 0,\n\t\t\touterHeight: 200,\n\n\t\t\tcolumnWidthInUse: 0,\n\t\t\tcolumnCount: 0,\n\n\t\t\tlocalList: [],\n\t\t\tlastRowBottomPosition: [],\n\t\t\tlastTriggerScrollTime: 0,\n\n\t\t\twidgetIDMax: 0,\n\t\t\tresizeTimer: null\n\t\t}\n\t},\n\ttemplate: template,\n\tmounted: function () {\n\n\t\tthis.lastRowBottomPosition = [];\n\n\t\tdocument.addEventListener('scroll', this.scrollListener)\n\t\twindow.addEventListener('resize', this.resizeListener)\n\t\tthis.buildLayout();\n\t\tthis.syncList()\n\t},\n\tmethods: {\n\t\tbuildLayout: function () {\n\t\t\tvar width = this.$refs.stickOuter.clientWidth;\n\t\t\t// this.localList = [];\n\t\t\tthis.lastRowBottomPosition = [];\n\t\t\tthis.columnCount = Math.max(Math.floor((width + this.columnSpacing) / (this.columnWidth + this.columnSpacing)), 1);\n\t\t\tif (this.columnCount === 1) {\n\t\t\t\tthis.columnWidthInUse = width\n\t\t\t} else {\n\t\t\t\tthis.columnWidthInUse = (width + this.columnSpacing) / this.columnCount - this.columnSpacing\n\t\t\t}\n\n\t\t},\n\t\trefresh: function () {\n\t\t\tvar me = this\n\t\t\tthis.buildLayout();\n\n\t\t\tthis.localList.forEach(function (widget) {\n\t\t\t\twidget.style.top = 0\n\t\t\t\twidget.style.left = 0\n\t\t\t\twidget.style.width = me.columnWidthInUse\n\t\t\t\twidget.style.visibility = 'hidden'\n\t\t\t})\n\t\t\tthis.$nextTick(function () {\n\t\t\t\tme.lastRowBottomPosition = []\n\t\t\t\tme.localList.forEach(function (widget) {\n\t\t\t\t\tvar node = me.$refs['widget-' + widget.id][0]\n\t\t\t\t\tif (widget.prepared) {\n\t\t\t\t\t\tme.fixItemPosition(node, widget)\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t})\n\t\t},\n\t\tscrollListener: function () {\n\t\t\tvar now = new Date().getTime()\n\n\t\t\tif (now - this.lastTriggerScrollTime > 500 && (getScrollTop() + window.innerHeight + this.loadTriggerDistance >= document.body.scrollHeight)) {\n\t\t\t\tthis.$emit('onScrollEnd')\n\t\t\t\tthis.lastTriggerScrollTime = now;\n\t\t\t}\n\t\t},\n\t\tresizeListener: function () {\n\t\t\tvar me = this\n\t\t\tclearTimeout(this.resizeTimer);\n\t\t\tthis.resizeTimer = setTimeout(function () {\n\t\t\t\tme.refresh();\n\t\t\t}, 500);\n\t\t},\n\t\tsyncList: function () {\n\t\t\tvar me = this\n\t\t\tvar listInScreen = this.localList.map(function (item) {\n\t\t\t\treturn item.data\n\t\t\t})\n\t\t\tthis.list.forEach(function (item) {\n\t\t\t\tif (listInScreen.indexOf(item) === -1) {\n\t\t\t\t\tme.addItem(item)\n\t\t\t\t}\n\t\t\t})\n\t\t\tif (this.list.length < this.localList.length) {\n\t\t\t\tconsole.log('有节点被删了！')\n\t\t\t\tfor (var index = this.localList.length - 1; index >= 0; index--) {\n\t\t\t\t\tif (this.list.indexOf(this.localList[index].data) === -1) {\n\t\t\t\t\t\tthis.localList.splice(index, 1)\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tme.refresh()\n\t\t\t}\n\t\t},\n\t\taddItem: function (item) {\n\t\t\tvar widget = {\n\t\t\t\tid: this.widgetIDMax++,\n\t\t\t\tstyle: {\n\t\t\t\t\tposition: 'relative',\n\t\t\t\t\ttop: 0,\n\t\t\t\t\tleft: 0,\n\t\t\t\t\twidth: this.columnWidthInUse,\n\t\t\t\t\tvisibility: 'hidden'\n\t\t\t\t},\n\t\t\t\tprepared: false,\n\t\t\t\tdata: item\n\t\t\t};\n\t\t\tvar me = this\n\n\t\t\tthis.localList.push(widget)\n\t\t\tthis.$nextTick(() => {\n\t\t\t\tvar widgetNode = me.$refs['widget-' + widget.id][0]\n\t\t\t\tvar imgNode = widgetNode.querySelector('img')\n\t\t\t\tvar imgSrc = imgNode ? imgNode.getAttribute('src') : ''\n\t\t\t\t\n\t\t\t\tgetImgSize(imgSrc, function () {\n\t\t\t\t\t// 标记已准备好\n\t\t\t\t\twidget.prepared = true\n\t\t\t\t\tme.fixItemPosition(widgetNode, widget);\n\t\t\t\t});\n\t\t\t})\n\t\t},\n\t\tfixItemPosition: function (node, widget) {\n\t\t\tvar columnIndex;\n\t\t\tvar top = 0;\n\t\t\tif (!node || !widget) {\n\t\t\t\treturn\n\t\t\t}\n\t\t\tvar widgetHeight = node.clientHeight\n\t\t\tif (this.lastRowBottomPosition.length < this.columnCount) {\n\t\t\t\t//第一排item\n\t\t\t\tcolumnIndex = this.lastRowBottomPosition.length;\n\t\t\t\tthis.lastRowBottomPosition.push(widgetHeight);\n\t\t\t} else {\n\t\t\t\t//其余\n\t\t\t\ttop = Math.min.apply(null, this.lastRowBottomPosition);\n\t\t\t\tcolumnIndex = this.lastRowBottomPosition.indexOf(top);\n\t\t\t\ttop = top + this.columnSpacing;\n\t\t\t}\n\t\t\twidget.style.position = 'absolute'\n\t\t\twidget.style.visibility = 'visible'\n\t\t\twidget.style.top = top\n\t\t\twidget.style.left = columnIndex * (this.columnWidthInUse + this.columnSpacing)\n\n\t\t\tnode.classList.add(this.animationClass)\n\t\t\tsetTimeout(function () {\n\t\t\t\tnode.classList.remove(this.animationClass);\n\t\t\t}, 1000);\n\t\t\tthis.lastRowBottomPosition[columnIndex] = top + widgetHeight;\n\t\t\tthis.outerHeight = Math.max.apply(null, this.lastRowBottomPosition) + this.columnSpacing\n\t\t}\n\t},\n\twatch: {\n\t\tlist: function () {\n\t\t\tthis.syncList()\n\t\t}\n\t},\n\tbeforeDestroy: function () {\n\t\tdocument.removeEventListener('scroll', this.scrollListener)\n\t\twindow.removeEventListener('resize', this.resizeListener)\n\t}\n}\n\n\nexport default {\n\tcomponent,\n\tinstall: function (Vue) {\n\t\tVue.component('Stick', component);\n\t}\n}\n","//图片预加载\nexport function getImgSize(src,callback){\n  if(!src){\n    setTimeout(callback, 0)\n    return;\n  }\n  var img = new Image();\n  function End(){\n    clearInterval(timer);\n    callback && callback();\n    callback = null;\n  }\n  img.onerror = img.onload = End;\n  var timer = setInterval(function(){\n    img.width>1 && End();\n  },2);\n  img.src=src;\n}\n\n/**\n * 获取浏览器滚动尺寸\n *  为了兼容firefox\n */\nexport function getScrollTop(){\n  return Math.max(document.documentElement.scrollTop, document.body.scrollTop);\n}"],"names":["component","props","list","type","Array","default","columnWidth","Number","animationClass","String","loadTriggerDistance","columnSpacing","data","count","outerHeight","columnWidthInUse","columnCount","localList","lastRowBottomPosition","lastTriggerScrollTime","widgetIDMax","resizeTimer","template","mounted","this","document","addEventListener","scrollListener","window","resizeListener","buildLayout","syncList","methods","width","$refs","stickOuter","clientWidth","Math","max","floor","refresh","me","forEach","widget","style","top","left","visibility","$nextTick","node","id","prepared","fixItemPosition","now","Date","getTime","documentElement","scrollTop","body","innerHeight","scrollHeight","$emit","clearTimeout","setTimeout","listInScreen","map","item","indexOf","addItem","length","console","log","index","splice","position","push","widgetNode","imgNode","querySelector","src","callback","img","Image","onerror","onload","End","timer","setInterval","clearInterval","getImgSize","getAttribute","columnIndex","widgetHeight","clientHeight","min","apply","classList","add","remove","watch","beforeDestroy","removeEventListener","install","Vue"],"mappings":"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"}